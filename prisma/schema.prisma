// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "sqlite"
  url       = env("DATABASE_URL")
}

enum UserRole {
  USER
  PREMIUM
  CREATOR
  ADMIN
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ULTRA
}

enum VideoQuality {
  SD_360
  HD_720
  FHD_1080
  UHD_4K
}

enum VideoStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  password      String
  firstName     String?
  lastName      String?
  avatar        String?
  role          UserRole @default(USER)
  isVerified    Boolean  @default(false)
  verificationToken String?
  resetToken    String?
  resetTokenExpiry DateTime?
  
  // Subscription
  subscription  Subscription?
  
  // Relations
  videos        Video[]
  watchHistory  WatchHistory[]
  favorites     Favorite[]
  comments      Comment[]
  ratings       Rating[]
  playlists     Playlist[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("users")
}

model Subscription {
  id            String           @id @default(cuid())
  userId        String           @unique
  tier          SubscriptionTier @default(FREE)
  stripeCustomerId String?
  stripeSubscriptionId String?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  isActive      Boolean          @default(false)
  
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  @@map("subscriptions")
}

model Video {
  id            String        @id @default(cuid())
  title         String
  description   String?
  thumbnail     String?
  duration      Int?          // in seconds
  views         Int           @default(0)
  likes         Int           @default(0)
  dislikes      Int           @default(0)
  status        VideoStatus   @default(UPLOADING)
  isPublic      Boolean       @default(true)
  isPremium     Boolean       @default(false)
  
  // Video files
  originalUrl   String?
  hlsUrl        String?       // HLS master playlist
  
  // Quality variants
  qualities     VideoQuality[]
  
  // Metadata
  tags          String[]
  category      String?
  language      String?
  
  // Relations
  uploaderId    String
  uploader      User          @relation(fields: [uploaderId], references: [id])
  
  watchHistory  WatchHistory[]
  favorites     Favorite[]
  comments      Comment[]
  ratings       Rating[]
  playlistItems PlaylistItem[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("videos")
}

model WatchHistory {
  id            String   @id @default(cuid())
  userId        String
  videoId       String
  watchedAt     DateTime @default(now())
  progress      Float    @default(0) // 0-1 (percentage watched)
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@unique([userId, videoId])
  @@map("watch_history")
}

model Favorite {
  id            String   @id @default(cuid())
  userId        String
  videoId       String
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([userId, videoId])
  @@map("favorites")
}

model Comment {
  id            String   @id @default(cuid())
  content       String
  userId        String
  videoId       String
  parentId      String?  // For replies
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  parent        Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies       Comment[] @relation("CommentReplies")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("comments")
}

model Rating {
  id            String   @id @default(cuid())
  rating        Int      // 1-5 stars
  userId        String
  videoId       String
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, videoId])
  @@map("ratings")
}

model Playlist {
  id            String         @id @default(cuid())
  name          String
  description   String?
  isPublic      Boolean        @default(true)
  userId        String
  
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         PlaylistItem[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("playlists")
}

model PlaylistItem {
  id            String   @id @default(cuid())
  playlistId    String
  videoId       String
  order         Int
  
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([playlistId, videoId])
  @@map("playlist_items")
}

model Analytics {
  id            String   @id @default(cuid())
  videoId       String?
  userId        String?
  event         String   // 'view', 'like', 'share', 'download'
  metadata      Json?
  
  createdAt     DateTime @default(now())
  
  @@map("analytics")
}