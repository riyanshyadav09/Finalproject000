version: '3.8'

services:
  # Bigtable Emulator
  bigtable-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:latest
    command: >
      sh -c "gcloud beta emulators bigtable start --host-port=0.0.0.0:8086"
    ports:
      - "8086:8086"
    environment:
      - BIGTABLE_EMULATOR_HOST=localhost:8086
    networks:
      - streamflix-db

  # Spanner Emulator
  spanner-emulator:
    image: gcr.io/cloud-spanner-emulator/emulator:latest
    ports:
      - "9010:9010"
      - "9020:9020"
    networks:
      - streamflix-db

  # PostgreSQL for Spanner-like functionality
  postgres-spanner:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=streamflix_spanner
      - POSTGRES_USER=spanner_user
      - POSTGRES_PASSWORD=spanner_pass
    ports:
      - "5433:5432"
    volumes:
      - spanner_data:/var/lib/postgresql/data
      - ./sql/spanner-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    networks:
      - streamflix-db

  # Redis for Bigtable-like functionality
  redis-bigtable:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - bigtable_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    networks:
      - streamflix-db

  # MinIO for Colossus-like object storage
  minio-colossus:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=streamflix
      - MINIO_ROOT_PASSWORD=streamflix123
    volumes:
      - colossus_data:/data
    command: server /data --console-address ":9001"
    networks:
      - streamflix-db

  # Database Manager Service
  db-manager:
    build:
      context: .
      dockerfile: Dockerfile.database
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - BIGTABLE_EMULATOR_HOST=bigtable-emulator:8086
      - SPANNER_EMULATOR_HOST=spanner-emulator:9010
      - POSTGRES_HOST=postgres-spanner
      - POSTGRES_PORT=5432
      - POSTGRES_DB=streamflix_spanner
      - POSTGRES_USER=spanner_user
      - POSTGRES_PASSWORD=spanner_pass
      - REDIS_HOST=redis-bigtable
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio-colossus:9000
      - MINIO_ACCESS_KEY=streamflix
      - MINIO_SECRET_KEY=streamflix123
    depends_on:
      - bigtable-emulator
      - spanner-emulator
      - postgres-spanner
      - redis-bigtable
      - minio-colossus
    networks:
      - streamflix-db

volumes:
  spanner_data:
  bigtable_data:
  colossus_data:

networks:
  streamflix-db:
    driver: bridge